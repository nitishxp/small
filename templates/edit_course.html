{% extends "website/_base.html" %} {% block main_content %}
{% load filter %}
<div class="x_content">
    <div class="form_wizard wizard_verticle">
        <ul class="list-unstyled wizard_steps anchor">
            <li>
                <a href="#course_info" class="selected timeline">
                    <span class="step_no">Course Info</span>
                </a>
            </li>
            <li>
                <a href="#student_enrollment" class="selected timeline">
                    <span class="step_no">Enrollment</span>
                </a>
            </li>
            <li>
                <a href="#student_grouping" class="selected timeline student_grouping">
                    <span class="step_no">Grouping</span>
                </a>
            </li>
            <li>
                <a href="#all_grades" class="selected timeline">
                    <span class="step_no">All Grades</span>
                </a>
            </li>
            <li>
                <a href="#peer_grades" class="selected timeline">
                    <span class="step_no">Peer Grades</span>
                </a>
            </li>
        </ul>
        <div class="stepContainer">
            <div id="course_info" class="content" style="display: none">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2> Create Course </h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <form method="POST" class="form-horizontal form-label-left">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="course_id">Course Id:
                                            <span class="required">*</span>
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <input type="text" id="course_id" name="course_id" value="{{ course.course_id }}" class="form-control col-md-7 col-xs-12" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="course_name">Course Name:
                                            <span class="required">*</span>
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <input type="text" id="course_name" name="course_name" value="{{ course.course_name }}" class="form-control col-md-7 col-xs-12" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="grading_rubric">Grading Policy
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <textarea name="grading_rubric" class="form-control col-md-7 col-xs-12" required id="grading_rubric" rows="15">{{ course.grading_rubric }}</textarea>
                                        </div>
                                    </div>
                                    <div class="form-group" style="display: none;">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="appeal_role">Explain the appeal role
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <textarea name="appeal_role" class="form-control col-md-7 col-xs-12" required id="appeal_role" rows="15">{{ course.appeal_role }}</textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="course_grading_type">Grading Type
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <select name="course_grading_type" class="form-control col-md-7 col-xs-12" required id="course_grading_type">
                                                <option value="N" {% if course.course_grading_type == "N" %}  selected {% endif %} >Number</option>
                                                <option value="A" {% if course.course_grading_type == "A" %}  selected {% endif %}>Alphabet</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="course_group_type">Group Type
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <select name="course_group_type" class="form-control col-md-7 col-xs-12" required id="course_group_type">
                                                <option value="same" {% if course.course_group_type == "same" %}  selected {% endif %}>Keep the Same</option>
                                                <option value="shuffle" {% if course.course_group_type == "shuffle" %}  selected {% endif %} >Shuffle</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group" style="display: none;">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="course_function">Function
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <select name="course_function" class="form-control col-md-7 col-xs-12" required id="course_function">
                                                <option value="g" {% if course.course_function == "g" %}  selected {% endif %} >Only Grouping</option>
                                                <option value="p" {% if course.course_function == "p" %}  selected {% endif %}>Peer Evalutation</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-4 col-sm-3 col-xs-12" for="appeal_role">
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <input type="button" value="Add Assignments" class="btn btn-primary" id="add_assignments">
                                        </div>
                                    </div>
                                    <table class="homework_assignment table table-border">
                                        {% for c in homework %}
                                        <tr>
                                            <td colspan="5">
                                                <label> Assignment {{ c.homework_name }} Title </label>
                                                <input type="text" name="{{ c.homework_name }}___assignment_title" value="{{ c.assignment_title }}"
                                                    class="form-control" required>
                                            </td>
                                        </tr>
                                        <tr class='assign_cl'>
                                            <td>
                                                <label> Assignment {{ c.homework_name }} Deadline </label>
                                                <br>
                                                <input type="datetime-local" name="{{ c.homework_name }}___homework_deadline" value="{{ c.homework_deadline|date:'c' }}"
                                                    class="form-control" required>
                                            </td>
                                            <td>
                                                <label> Grading Deadline </label>
                                                <br>
                                                <input type="datetime-local" name="{{ c.homework_name }}___grade_deadline" value="{{ c.grade_deadline|date:'c' }}" class="form-control"
                                                    required>
                                            </td>
                                            <!-- <td>
                                                <label> Grouping Constraints </label>
                                                <br>
                                                <select name="{{ c.homework_name }}___constraints" required>
                                                    <option value="random" selected> Random Group</option>
                                                    <option value="similar_schedule"> Group Similar Schedule </option>
                                                    <option value="similar_commitment_level"> Group Similar Commitment Level </option>
                                                    <option value="similar_skills"> Group Similar Skills </option>
                                                    <option value="different_skills"> Group different Skills </option>
                                                </select>
                                            </td> -->
                                            <td>
                                                <input type="hidden" name="{{ c.homework_name }}___constraints" value="random" required>
                                            </td>
                                            <td>
                                                <label>No. of Students Per Group</label>
                                                <br>
                                                <input type="number" min="1" name="{{ c.homework_name }}___no_of_group" value="{{c.no_of_group}}" class="form-control" required>
                                            </td>
                                            <td>
                                                <label>No. Of Graders</label>
                                                <br>
                                                <input type="number" min="1" name="{{ c.homework_name }}___no_of_grader" value="{{c.no_of_grader}}" class="form-control"
                                                    required>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="5">
                                                <label>Grading Rubric</label><br>
                                                <textarea name="{{ c.homework_name }}___grade_rubric"  class="form-control" rows="5" required> {{ c.grade_rubric}} </textarea>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </table>
                                    <div class="form-group">
                                        <div class="col-md-4 col-sm-3 col-xs-12"></div>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <input type="submit" value="Submit" class="btn btn-primary">
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div id="student_upload" class="content" style="display: none">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        
                    </div>
                </div>
            </div>  -->
            <div id="student_enrollment" class="content" style="display: none">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2> Student Upload </h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <form action="{% url 'instructor__student_upload' course_pk %}" method="POST" enctype="multipart/form-data" class="form-horizontal form-label-left">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="course_id">Upload Student Csv
                                        </label>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <input type="file" accept=".csv" class="form-control col-md-7 col-xs-12" required="True" name="student_upload">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-4 col-sm-3 col-xs-12"></div>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <input type="submit" value="Upload" class="btn btn-primary">
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="x_panel">
                            <div class="x_title">
                                <h2> Course Student </h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <table class="table" id="student_enrollment_list">
                                    <thead>
                                        <tr>
                                        <th> Student Name</th>
                                        <th>Enrollment Status</th>
                                        <th> Action </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        {% for c in enrolled_student %}
                                        <tr>
                                            <td>{{ c.user.name }}</td>
                                            <td>
                                                <input type="checkbox" value="{{ c.user.id }}" {% if c.enrollment_status %} checked {% endif %}>
                                            </td>
                                            <td> <input type="button" value="Delete" class="delete_btn" data-user="{{ c.user.id }}">  </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="student_grouping" class="content" style="display: none">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2>
                                    Groups
                                </h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <div class="" role="tabpanel" data-example-id="togglable-tabs">
                                    <ul id="myTab" class="nav nav-tabs bar_tabs">
                                        {% for k,v in group_grades.items %}
                                        <li>
                                            <a href="#assignment{{k}}" id="home-tab" role="tab" data-toggle="tab" aria-expanded="true">{{v.title}}</a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <div id="myTabContent" class="tab-content">
                                        {% for key , values in group_grades.items %}
                                        <div role="tabpanel" class="tab-pane fade" id="assignment{{key}}" aria-labelledby="home-tab">
                                            <table class="table table-border nowrap" id="table{{key}}" style="width:100%">
                                                <thead>
                                                    <th>ID</th>
                                                    <th>Group</th>
                                                    <th>Grader</th>
                                                    <th>Grade</th>
                                                    <th>Explanation</th>
                                                    <th>HW Download</th>
                                                    <th>Appeal Grader</th>
                                                    <th>Appeal Grade</th>
                                                    <th>Appeal Explanation</th>
                                                </thead>
                                                <tbody>
                                                    {% for v in values.value %}
                                                    <tr>
                                                        <td>{{ v.group_id }}</td>
                                                        <td>{{ v.group|linebreaks }}</td>
                                                        <td>{{ v.grader|linebreaks }}</td>
                                                        <td>
                                                            {{ v.grade|linebreaks }}
                                                        </td>
                                                        {% if v.deadline_miss %}
                                                            <td>
                                                                <span style="color: red">Late Submission</span>
                                                                <br>
                                                                {% if v.updated_at %}
                                                                    {{ v.updated_at }}
                                                                {% else %}
                                                                    No Time Available
                                                                {% endif %}

                                                            </td>
                                                        {% else %}
                                                            <td>{{ v.explanation|linebreaks }}</td>
                                                        {% endif %}

                                                        {% if v.file is None or v.file == "None" %}
                                                                <td> </td>
                                                            {% else %}
                                                                <td><a href="{{v.file}}"> Download </a></td>
                                                        {% endif %}
                                                        
                                                        <td>{{ v.appeal_grader|linebreaks }}</td>
                                                        {% comment %}
                                                        {% if v.deadline_miss %}
                                                            <td>NA</td>
                                                            <td>NA</td>
                                                        {% else %}
                                                            <td>{{ v.appeal_grade|linebreaks }}</td>
                                                            <td>{{ v.appeal_explanation|linebreaks }}</td>
                                                        {% endif %}
                                                        {% endcomment %}
                                                        <td>
                                                            <select class="form-control instructor_override" data-group="{{ v.id }}" >
                                                                <option value=""> Select </option>
                                                                <option value="A"  {% if v.appeal_grade == "A" %}   selected {% endif %}> A</option>
                                                                <option value="A-" {% if v.appeal_grade == "A-" %}  selected {% endif %}> A-</option>
                                                                <option value="B+" {% if v.appeal_grade == "B+" %}  selected {% endif %}> B+</option>
                                                                <option value="B"  {% if v.appeal_grade == "B" %}   selected {% endif %}> B</option>
                                                                <option value="B-" {% if v.appeal_grade == "B-" %}  selected {% endif %}> B-</option>
                                                                <option value="C+" {% if v.appeal_grade == "C+" %}  selected {% endif %}> C+</option>
                                                                <option value="C"  {% if v.appeal_grade == "C" %}   selected {% endif %}> C</option>
                                                                <option value="C-" {% if v.appeal_grade == "C-" %}  selected {% endif %}> C-</option>
                                                                <option value="D+" {% if v.appeal_grade == "D+" %}  selected {% endif %}> D+</option>
                                                                <option value="D"  {% if v.appeal_grade == "D" %}   selected {% endif %}> D</option>
                                                                <option value="D-" {% if v.appeal_grade == "D-" %}  selected {% endif %}> D-</option>
                                                                <option value="F"  {% if v.appeal_grade == "F" %}   selected {% endif %}> F</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <textarea class="instructor_override_explanation" data-group="{{ v.id }}">{{ v.appeal_explanation.strip }}</textarea>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="x_title">
                                <h2> Student Grouping </h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <div class="row">
                                    <div class="col-md-3">
                                    </div>
                                    <div class="col-md-3">
                                        <form action="{% url 'instructor__do_grouping' course_pk %}" method="POST">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <div class="col-md-4 col-sm-3 col-xs-12"></div>
                                                <div class="col-md-6 col-sm-6 col-xs-12">
                                                    <input type="submit" value="Do Grouping" class="btn btn-primary">
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-md-3">
                                        <form action="{% url 'instructor__re_grouping' course_pk %}" method="POST" onsubmit="return validate(this)">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <div class="col-md-4 col-sm-3 col-xs-12"></div>
                                                <div class="col-md-6 col-sm-6 col-xs-12">
                                                    <input type="submit" value="Redo Grouping" class="btn btn-primary">
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-md-3">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="all_grades" class="content" style="display: none">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2> All Grades </h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <table id="group_all_grade" class="table">
                                    <thead>
                                        <th> Name</th>
                                        {% for c in homework %}
                                        <th>HW {{ c.homework_name }}</th>
                                        {% endfor %}
                                        <th> Total</th>
                                    </thead>
                                    <tbody>
                                        {% for key,values in all_grades.items %}
                                        <tr>
                                            <td>{{ values.name }}</td>
                                            {% for grade in values.grade %}
                                                {% if course.course_grading_type == "A" %}
                                                    <td> {{ grade|grade_alphabet }}</td>
                                                {% else %}
                                                    <td> {{ grade|grade_number }}</td>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="peer_grades" class="content" style="display: none">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2> Peer Grades </h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <table id="first_grade_grading" class="table">
                                    <thead>
                                        <th> Name</th>
                                        {% for c in homework %}
                                        <th>HW {{ c.homework_name }} Grading quality</th>
                                        {% endfor %}
                                        <th> Total</th>
                                    </thead>
                                    <tbody>
                                        {% for key,values in first_grader_grading.items %}
                                        <tr>
                                            <td>{{ values.name }}</td>
                                            {% for grade in values.grade %}
                                                {% if course.course_grading_type == "A" %}
                                                    <td> {{ grade|grade_alphabet }}</td>
                                                {% else %}
                                                    <td> {{ grade|grade_number }}</td>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script>
    $(document).on('ready', function () {

        $('#group_all_grade').DataTable({
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ],
            bRetrieve: true,
            dom: "Bfrtip",
        });
        
        {% for key , values in group_grades.items %}
            var datatable{{key}} = $('#table{{key}}').DataTable({
             "aoColumnDefs": [{ "bVisible": false, "aTargets": [] }],

                buttons: [
                     'csv', 'pdf', 'print',{
                        text: 'Download Homework',
                        action: function ( e, dt, node, config ) {
                            console.log(e,dt,node,config);
                            window.location = 'download_all_homework/{{ key }}/'
                        }
                    }
                ],
                bRetrieve: true,
                dom: "Bfrtip",
                bScrollCollapse : true,
            });

        // datatable{{key}}.scroller.measure().draw(false);
        //  var table{{key}} = $('#table{{key}}').DataTable();
        //  table{{key}}.MakeCellsEditable({
        //     "onUpdate": myCallbackFunction,
        //     "columns": [8],
        //     "allowNulls": {
        //         "columns": [8],
        //         "errorClass": 'error'
        //     },
        //     "inputTypes": [
        //         {
        //             "column": 8,
        //             "type": "textarea",
        //         },
        //         {
        //         "column":7,
        //         "type": "list",
        //         "options":[
        //             { "value":  "" , "display": "" },
        //             { "value":  "A" , "display": "A" },
        //             { "value": "A-" , "display": "A-" },
        //             { "value": "B+" , "display": "B+" },
        //             { "value":  "B" , "display": "B" },
        //             { "value": "B-" , "display": "B-" },
        //             { "value": "C+" , "display": "C+" },
        //             { "value":  "C" , "display": "C" },
        //             { "value": "C-" , "display": "C-" },
        //             { "value": "D+" , "display": "D+" },
        //             { "value":  "D" , "display": "D" },
        //             { "value": "D-" , "display": "D-" },
        //             { "value":  "F" , "display": "F" },
        //         ]
        //     }]
        // });
        {% endfor %}

        // function myCallbackFunction(updatedCell, updatedRow, oldValue) {
        //     if (updatedCell.data() != "NA" || updatedCell.data()){
        //         console.log("FIre ajax to db");
        //         data = updatedRow.data();
        //         console.log(data);
        //         if (!confirm("Are u sure u want to edit")){
        //             return
        //         }
        //         if (data[7] === "")
        //         {
        //             return;
        //         }
        //         data[7] = data[7].replace("<p>","");
        //         data[7] = data[7].replace("</p>","").trim();
        //         data[8] = data[8].replace("<p>","");
        //         data[8] = data[8].replace("</p>","").trim();
        //         $.ajax({
        //             url : "override/",
        //             method : 'POST',
        //             data : {'explanation':data[8],'id':data[0]},
        //         })
        //     }
        // }

        $('.instructor_override_explanation').on('focusout', function() {
          let id = $(this).data('group');
          let explanation = $(this).val();
          console.log(explanation);
          $.ajax({
                url : "override/",
                method : 'POST',
                data : {'explanation':explanation,'id':id },
                success : function (result) {
                }
            })
        });

        $(document).on("change",".instructor_override",function () {
            if (!confirm("Are u sure u want to edit")){
                    return false;
            }
            let id = $(this).data('group');
            let grade = $(this).val();
            $.ajax({
                url : "override/",
                method : 'POST',
                data : {'grade':grade,'id':id },
                success : function (result) {
                    alert('Updated');
                }
            })
        });

        $('#student_enrollment_list').DataTable({
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ],
            bRetrieve: true,
            dom: "Bfrtip",
        });

        $('#first_grade_grading').DataTable({
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ],
            bRetrieve: true,
            dom: "Bfrtip",
        });


        $(document).on('click',"input[type='checkbox']", function(){
	        a = $(this).is(":checked");
            $.ajax({
                    url : "enroll/",
                    method : 'POST',
                    data : {'userId':$(this).val(),'status':a},
                    success: function(result){
                        alert('Status Changed');
                    }
            })
        });


        $(".delete_btn").on('click', function(){
            var user = $(this).data("user");
            var tr = this;
            $.ajax({
                    url : "delete_student/",
                    method : 'POST',
                    data : {'userId': user },
                    success: function(result){
                       $(tr).closest('tr').hide();
                       alert('Deleted');
                    }
            })
        })
    });

    function validate(form) {
        return confirm('Are you sure you want to redo grouping?');
    }
</script> {% endblock %}
